name: Code Quality Check

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**.ts'
      - '**.tsx'
      - '**.js'
      - '**.jsx'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'eslint.config.js'
      - '.prettierrc'

jobs:
  quality-check:
    name: Lint, Format & Type Check
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        id: lint
        run: pnpm lint 2>&1 | tee lint.log
        continue-on-error: true

      - name: Run Prettier Check
        id: format
        run: pnpm format --check 2>&1 | tee format.log
        continue-on-error: true

      - name: Run Type Check
        id: typecheck
        run: pnpm type-check 2>&1 | tee typecheck.log
        continue-on-error: true

      - name: Check Results
        id: check
        run: |
          FAILED=false

          if [ ${{ steps.lint.outcome }} == 'failure' ]; then
            echo "LINT_FAILED=true" >> $GITHUB_ENV
            FAILED=true
          fi

          if [ ${{ steps.format.outcome }} == 'failure' ]; then
            echo "FORMAT_FAILED=true" >> $GITHUB_ENV
            FAILED=true
          fi

          if [ ${{ steps.typecheck.outcome }} == 'failure' ]; then
            echo "TYPECHECK_FAILED=true" >> $GITHUB_ENV
            FAILED=true
          fi

          if [ "$FAILED" = true ]; then
            exit 1
          fi

      - name: Comment on PR (Failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## Code Quality Check Failed\n\n';

            if (process.env.LINT_FAILED === 'true') {
              let lintLog = '';
              if (fs.existsSync('lint.log')) {
                lintLog = fs.readFileSync('lint.log', 'utf8').slice(0, 2000);
              }
              comment += '### ESLint Errors\n';
              if (lintLog) {
                comment += '```\n' + lintLog + '\n```\n';
              }
              comment += 'Fix: `pnpm lint:fix`\n\n';
            }

            if (process.env.FORMAT_FAILED === 'true') {
              comment += '### Prettier Formatting Errors\n';
              comment += 'Fix: `pnpm format`\n\n';
            }

            if (process.env.TYPECHECK_FAILED === 'true') {
              let typecheckLog = '';
              if (fs.existsSync('typecheck.log')) {
                typecheckLog = fs.readFileSync('typecheck.log', 'utf8').slice(0, 2000);
              }
              comment += '### TypeScript Type Errors\n';
              if (typecheckLog) {
                comment += '```\n' + typecheckLog + '\n```\n';
              }
              comment += '\n';
            }

            comment += '---\n';
            comment += 'Quick fix:\n';
            comment += '```bash\n';
            comment += 'pnpm lint:fix && pnpm format\n';
            comment += '```\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment on PR (Success)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## Code Quality Check Passed\n\nAll checks passed successfully.'
            });
